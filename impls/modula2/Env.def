DEFINITION MODULE Env;

(* MAL Environment - Definition Module *)
(* Optimized with symbol interning, hash table for REPL, and symbol cache *)

FROM Types IMPORT MalVal;
FROM SYSTEM IMPORT ADDRESS;
FROM DynString IMPORT String;

TYPE
  (* Symbol - interned string for fast comparison *)
  Symbol = POINTER TO SymbolRec;

  SymbolRec = RECORD
    str: String;         (* The string representation *)
    hash: CARDINAL;      (* Precomputed hash for fast comparison *)
    next: Symbol;        (* For hash collision chain *)
  END;

  (* Binding - a single key-value pair *)
  Binding = POINTER TO BindingRec;

  BindingRec = RECORD
    sym: Symbol;      (* Interned symbol (fast pointer comparison) *)
    val: MalVal;
    next: Binding;    (* Next binding in the linked list *)
  END;

  (* Environment - optimized with hash table for REPL level *)
  Env = POINTER TO EnvRec;

  EnvRec = RECORD
    bindings: Binding;    (* Local bindings as linked list *)
    hashTable: POINTER TO ARRAY [0..31] OF Binding;  (* Hash table for REPL env (NIL for local envs) *)
    outer: Env;           (* Parent environment *)
  END;

(* Create a new environment with optional outer scope *)
PROCEDURE NewEnv(): Env;
PROCEDURE NewEnvOuter(outerEnv: Env): Env;

(* Create REPL environment with hash table optimization *)
PROCEDURE NewReplEnv(): Env;

(* Set a symbol in the environment *)
PROCEDURE EnvSetArray(env: Env; key: ARRAY OF CHAR; val: MalVal);
PROCEDURE EnvSetString(env: Env; key: String; val: MalVal);

(* Get a symbol from the environment - returns value and sets found flag *)
PROCEDURE EnvGetArray(env: Env; key: ARRAY OF CHAR; VAR found: BOOLEAN): MalVal;
PROCEDURE EnvGetString(env: Env; key: String; VAR found: BOOLEAN): MalVal;

(* Check if a symbol exists in the environment (deprecated - use EnvGetArray with found flag) *)
PROCEDURE EnvFindArray(env: Env; key: ARRAY OF CHAR): BOOLEAN;

(* Symbol interning - convert string to interned symbol *)
PROCEDURE InternSymbol(key: ARRAY OF CHAR): Symbol;

(* Pre-intern common REPL symbols for fast lookup *)
PROCEDURE PreInternSymbols();

(* Profiling functions *)
PROCEDURE GetEnvStats(VAR creates, gets, getSteps, sets: CARDINAL);
PROCEDURE GetCacheStats(VAR hits, misses: CARDINAL);
PROCEDURE ResetEnvStats();

END Env.
